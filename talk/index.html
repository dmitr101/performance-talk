<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Performance talk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="node_modules/reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="node_modules/reveal.js/dist/theme/black.css">
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h2>Going fast!</h2>
                <h4>Software performance on modern systems</h4>
                <h6>Dmytro Shynkar</h6>
            </section>
            <section>
                <h3>A bit of context</h3>
                <section>
                    <p>I spent last couple years helping to build this game</p>
                    <iframe width="700" height="480" src="https://www.youtube.com/embed/Q_HX5JyT18o?start=29&end=59"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </section>
                <section>
                    <p>A fast paced multiplayer FPS with destructible environments</p>
                    <ul>
                        <li>Fast and responsive movement</li>
                        <li>Everything around is destructible</li>
                        <li>(Un)controllably chaotic battles</li>
                    </ul>
                </section>
                <section>
                    <p style="padding: 0; margin-top: 50px; margin-bottom: 0;">Performance is critical</p>
                    <dev class="fragment">
                        <p style="padding: 0; margin-top: 0; margin-bottom: 0;">Nobody would want to play like this</p>
                        <video style="padding: 0; margin-top: 0; margin-bottom: 0;" width="700" height="480" autoplay
                            loop>
                            <source src="finals_choppy.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </dev>
                    <p style="padding: 0;margin-top: 0; margin-bottom: 0;" class="fragment">Though some still do...</p>
                </section>
            </section>
            <section>
                <h4>So basically</h4>
                <img src="sonec.webp" />
            </section>
            <section>
                <h3>Not only games</h3>
                <ul>
                    <li class="fragment">The Amazon latency-to-revenue study <em class="fragment"
                            style="font-size: 10px;">sources are somewhat
                            dubios</em></li>
                    <li class="fragment">Mobile applications battery usage</li>
                    <li class="fragment">Cloud/infra costs</li>
                    <li class="fragment">much more</li>
                </ul>
                <p class="fragment" style="font-size: 20px;"><em>There's a reason big companies keep investing into
                        faster software</em></p>
            </section>
            <section>
                <h3>Some examples</h3>
                <ul>
                    <li><a href="https://v8.dev/blog/holiday-season-2023">Google spends ungodly amounts of engeneering
                            resources on V8 and WASM</a></li>
                    <li><a
                            href="https://engineering.fb.com/2016/09/22/networking-traffic/redesigning-the-hhvm-jit-compiler-for-better-performance/">Same
                            for Meta and HHVM</a></li>
                    <li><a href="https://www.uber.com/en-SE/blog/employing-quic-protocol/">Uber switches it's app to
                            QUIC for better latency</a></li>
                    <li><a href="https://medium.com/@amerather_9719/intel-optimization-at-netflix-79ef0efb9d2">Netflix
                            hotpatches their cloud deployments and works with Intel to squeeze every drop</a></li>
                    <li>And much more <p style="font-size: 20px;">this is just what 15 minutes of googling shows</p>
                    </li>
                </ul>
            </section>
            <section>
                <h3>What is Performance?</h3>
                <section>
                    <ul>
                        <li class="fragment">How fast a single unit of work gets done - <em>latency</em></li>
                        <li class="fragment">How much work gets done in a unit of time - <em>throughput</em></li>
                    </ul>
                    <div class="fragment">
                        <img src="cropped-fast-car.png" style="width: 250px; height: 250px;" />
                        <img src="cropped-big-car.png" style="width: 250px; height: 250px;" />
                    </div>
                </section>
                <section>
                    <h3>Latency</h3>
                    <img src="weird_spinner.gif" style="width: 350px; height: 350px;">
                </section>
                <section>
                    <h3>Latency</h3>
                    <ul>
                        <li>A lot of times <em>the</em> thing that leads to things feeling slow</li>
                        <li>Crazy important for games and any other interactive media</li>
                        <li>Oftentimes heavily impacted by IO performance</li>
                        <li class="fragment"><em>Average values are dangerously misleading</em></li>
                    </ul>
                </section>
                <section>
                    <h3>Throughput</h3>
                    <ul>
                        <li>More of a measure of whole system's performance</li>
                        <li>Absolutely critical for non-interactive workloads</li>
                    </ul>
                </section>
                <section>
                    <p class="fragment">Naively: lower the latency - better the throughput</p>
                    <img class="fragment" src="escallator.jpg" style="width: 450px; height: 450px;">
                </section>
                <section>
                    <p>Just like gravity, <a href="https://www.youtube.com/watch?v=Hda5tMrLJqc">Queueing Theory</a>
                        isn't kind</p>
                    <p class="fragment"><em>Bad engineering decisions can absolutely ruin both!</em></p>
                </section>
                <section>
                    <h3>Other types of software performance</h3>
                    <ul>
                        <li>Scalability</li>
                        <li>Utilization</li>
                        <li>Energy efficiency</li>
                        <li>IOPS</li>
                        <li>Probably infinitely more</li>
                    </ul>
                </section>
            </section>
            <section>
                <h2>Hardware context</h2>
                <section>
                    <p>All software ultimatevely runs on some kind of hardware</p>
                    <div class="fragment" style="text-align:center;">
                        <p style="width:300px; height: fit-content; display:inline-block; vertical-align:middle;">Even
                            if it takes a long chain of abstractions to get there</p>
                        <img style="width:300px; height: fit-content; display:inline-block; vertical-align:middle;"
                            src="scratch.webp" />
                    </div>
                </section>
                <section>
                    <h3>Why does it matter?</h3>
                    <div class="fragment" style="text-align:center;">
                        <img src="6502.jpg" alt="6502 Processor"
                            style="width:400px; height: fit-content; display:inline-block; vertical-align:middle;">
                        <span style="font-size:24px; display:inline-block; vertical-align:middle;"> &#8800; </span>
                        <img src="corei9.jpg" alt="Core i9 Processor"
                            style="width:400px; height: fit-content; display:inline-block; vertical-align:middle;">
                    </div>
                </section>
            </section>
            <section>
                <h2>Enough rambling</h2>
                <img src="boids-screen-py.png" style="width: 800px; height: 600px;" />
            </section>
            <section>
                <h2>Demo time</h2>
            </section>
            <section>
                <h3>Was it good?</h3>
                <p>Let's see!</p>
            </section>
            <section>
                <h3>Boids</h3>
                <section>
                    <p>A really simple algorithm giving surprisingly good results</p>
                    <ul>
                        <li>Each boid follows 3 simple rules</li>
                        <li>Alignment</li>
                        <li>Cohesion</li>
                        <li>Separation</li>
                    </ul>
                </section>
                <section>
                    <p>Alignment</p>
                    <img src="boid-alignment.png" style="width:600px;" />
                </section>
                <section>
                    <p>Cohesion</p>
                    <img src=" boid-cohesion.png" style="width:600px;" />
                </section>
                <section>
                    <p>Separation</p>
                    <img src="boid-separation.png" style="width:600px;">
                </section>
                <section>
                    <p>For each boid out of N</p>
                    <ul>
                        <li>6n distance calculations + ~10 flops</li>
                        <li class="fragment">Distance calculation depending on impl may be just 2-3 flops </li>
                        <li class="fragment">2.5kflops per boid, or 1M flops for 400</li>
                        <li class="fragment">Let's be generous and say 2M per iteration</li>
                        <li class="fragment">So for 15FPS we come to ~30M flop/s</li>
                    </ul>
                </section>
            </section>
            <section>
                <h3>Profiling time</h3>
                <section>
                    <p>Except it's not that easy!</p>
                    <ul>
                        <li>Frame time includes input handling and drawing</li>
                        <li>Profilers to the resque!</li>
                    </ul>
                </section>
            </section>
            <section>
                <h2>Demo time</h2>
            </section>
            <section>
                <h3>Profiling time</h3>
                <p>This time we basically guessed right</p>
                <p class="fragment">Let's correct to ~32M flop/s</p>
            </section>
            <section>
                <h3>This machine</h3>
                <section>
                    <ul>
                        <li>AMD Ryzen 9 5900HS</li>
                        <li>32GB DDR4</li>
                        <li>RTX 3060</li>
                    </ul>
                    <h3 class="fragment" style="margin-top: 50px;">47 GFlops/sec</h3>
                    <em class="fragment" style="font-size: 15px;">Just on the CPU</em>
                </section>
            </section>
            <section>
                <h3>Napkin math</h3>
                <p>1400x slower than the machines hypothetical speed</p>
                <p class="fragment">Why?</p>
            </section>
            <section>
                <h3>How Python works</h3>
                <section>
                    <img src="py_exec.webp" />
                </section>
                <section>
                    <a href="https://godbolt.org/z/x5zTeEvE6">Let's look at what runs</a>
                    <ul class="fragment">
                        <li>Bytecode != assembly</li>
                        <li>Interpreters can still be written to be highly efficient</li>
                        <li>i.e. <a
                                href="https://www.reddit.com/r/programming/comments/badl2/comment/c0lrus0/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button">LuaJIT</a>
                        </li>
                        <li>CPython is not one of those interpreters</li>
                        <li>Fast things in Python are not written in Python</li>

                    </ul>
                    <p class="fragment" style="font-size: 15px;">I still write a lot of it</p>
                </section>
            </section>
            <section>
                <h3>Rewrite it in Rust!</h3>
                <p>While keeping as much semantics as possible</p>
                <p class="fragment">Is it better?</p>
            </section>
            <section>
                <h2>Demo time</h2>
                <!--Show debug and then release version-->
            </section>
            <section>
                <h3>Seems to be!</h3>
                <p>~3x or 90Mflop/s</p>
                <p>~25x or 0.75Gflop/s</p>
            </section>
            <section>
                <h3>Abstract machine and optimization</h3>
                <section>
                    <ul>
                        <li>Rust isn't "close to the metal"</li>
                        <li>Neither is C or C++</li>
                        <li>In every case we're programming against the abstract machine</li>
                        <li>That's where we get undefined behavior and other fun things from</li>
                    </ul>
                </section>
                <section>
                    <ul>
                        <li>LLVM is really good at translating the abstract to concrete</li>
                        <li><a>First version</a></li>
                        <li><a>Second version</a></li>
                    </ul>
                </section>

            </section>

            </section>
            <!-- <section>
                <h3 style="margin-bottom: 0;">Coming back to hardware</h3>
                <img src="Zen3_arch_5.jpg" style="height: 630px;" />
            </section> -->
        </div>
    </div>
    <script src="node_modules/reveal.js/dist/reveal.js"></script>
    <script>
        Reveal.initialize({ history: true, slideNumber: true });
    </script>
</body>

</html>